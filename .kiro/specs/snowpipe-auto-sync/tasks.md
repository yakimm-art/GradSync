# Implementation Plan

- [x] 1. Create storage integration templates and configuration scripts
  - [x] 1.1 Create AWS S3 storage integration template SQL
    - Write SQL template with placeholders for bucket, IAM role ARN
    - Include comments explaining each configuration option
    - _Requirements: 1.1_
  - [x] 1.2 Create Azure Blob storage integration template SQL
    - Write SQL template with placeholders for account, container, tenant ID
    - Include comments explaining Azure-specific configuration
    - _Requirements: 1.2_
  - [x] 1.3 Create GCS storage integration template SQL
    - Write SQL template with placeholders for bucket, service account
    - Include comments explaining GCS-specific configuration
    - _Requirements: 1.3_
  - [x] 1.4 Create unified configuration script with provider selection
    - Write SQL script that includes all three provider options (commented)
    - Add validation queries to test connectivity
    - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 2. Implement Snowpipe definitions for all data types
  - [x] 2.1 Create attendance Snowpipe with JSON parsing
    - Define COPY INTO statement with JSON field extraction
    - Map JSON fields to landing table columns
    - Store raw payload in VARIANT column
    - _Requirements: 2.1, 2.4_
  - [x] 2.2 Write property test for raw payload preservation
    - **Property 1: Raw Payload Preservation (Round-Trip)**
    - **Validates: Requirements 2.4**
    - Implemented in tests/test_snowpipe_properties.py::TestRawPayloadPreservation
  - [x] 2.3 Create grades Snowpipe with JSON parsing
    - Define COPY INTO statement for grade events
    - Handle score/max_score decimal parsing
    - Store raw payload for audit
    - _Requirements: 2.2, 2.4_
  - [x] 2.4 Create students Snowpipe with JSON parsing
    - Define COPY INTO statement for student events
    - Handle optional parent_language field with default
    - Store raw payload for audit
    - _Requirements: 2.3, 2.4_
  - [x] 2.5 Write property test for malformed JSON handling
    - **Property 4: Malformed JSON Rejection**
    - **Validates: Requirements 2.5**
    - Implemented in tests/test_snowpipe_properties.py::TestMalformedJsonHandling

- [x] 3. Implement streams and processing tasks
  - [x] 3.1 Create streams on all landing tables
    - Create ATTENDANCE_EVENTS_STREAM
    - Create GRADES_EVENTS_STREAM
    - Create STUDENTS_EVENTS_STREAM
    - _Requirements: 3.1_
  - [x] 3.2 Implement attendance processing task with event type mapping
    - Create task with WHEN SYSTEM$STREAM_HAS_DATA condition
    - Implement CASE statement for event_type to status mapping
    - Use MERGE to prevent duplicates
    - _Requirements: 3.2, 3.3, 3.4_
  - [x] 3.3 Write property test for event type mapping
    - **Property 2: Event Type to Status Mapping**
    - **Validates: Requirements 3.3**
    - Implemented in tests/test_snowpipe_properties.py::TestEventTypeMapping
  - [x] 3.4 Write property test for processing idempotency
    - **Property 3: Processing Idempotency**
    - **Validates: Requirements 3.4**
    - Implemented in tests/test_snowpipe_properties.py::TestProcessingIdempotency
  - [x] 3.5 Implement grades processing task
    - Create task to transform grade events to normalized GRADES table
    - Use MERGE for upsert behavior
    - _Requirements: 3.2_
  - [x] 3.6 Implement students processing task
    - Create task to transform student events to normalized STUDENTS table
    - Handle create/update/transfer event types
    - Use MERGE for upsert behavior
    - _Requirements: 3.2_

- [x] 4. Checkpoint - All tests pass
  - Property tests implemented and passing
  - Run: pytest tests/test_snowpipe_properties.py -v

- [x] 5. Create monitoring views and status functions
  - [x] 5.1 Create Snowpipe status view
    - Create view that queries SYSTEM$PIPE_STATUS for all pipes
    - Include pipe name, state, last ingestion time
    - _Requirements: 4.1_
  - [x] 5.2 Create ingestion metrics view
    - Query COPY_HISTORY for file and record counts
    - Aggregate by pipe and time period (24h, 7d)
    - _Requirements: 4.2, 4.3_
  - [x] 5.3 Create error log view
    - Query COPY_HISTORY for failed ingestions
    - Include file name, error message, timestamp
    - _Requirements: 4.4_

- [x] 6. Create test data and verification scripts
  - [x] 6.1 Create sample JSON test files
    - Create attendance_sample.json with valid events
    - Create grades_sample.json with valid events
    - Create students_sample.json with valid events
    - Create malformed_sample.json for error testing
    - _Requirements: 5.1_
  - [x] 6.2 Create end-to-end test script
    - Script to upload test file to internal stage
    - Query to verify data in landing table
    - Query to verify data in normalized table
    - _Requirements: 5.2, 5.3, 5.4_
  - [x] 6.3 Create diagnostic queries for troubleshooting
    - Queries to check pipe status
    - Queries to check stream offset
    - Queries to check task history
    - _Requirements: 5.5_

- [x] 7. Add auto-sync monitoring to Streamlit app
  - [x] 7.1 Create Auto-Sync Status page in navigation
    - Add new page to navigation menu
    - Display Snowpipe status for each pipe
    - Show ingestion metrics (files/records in last 24h)
    - _Requirements: 4.1, 4.2, 4.3_
  - [x] 7.2 Add error log display
    - Show recent ingestion errors
    - Include file name and error message
    - _Requirements: 4.4_
  - [x] 7.3 Add test upload functionality
    - File uploader for test JSON files
    - Button to trigger test and show results
    - _Requirements: 5.1, 5.2, 5.3_

- [x] 8. Final Checkpoint - All tests pass
  - All property tests implemented and verified
  - Issue #9 complete
